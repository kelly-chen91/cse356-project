<!DOCTYPE html>
<html>
  <head>
    <title>MPEG-DASH Media Player</title>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  </head>

  <body>
    <div id="container"></div>
    <script>
      const container = document.getElementById("container");

      const videos = [];

      const count = 10;

      async function updateLike(id, value) {
        const like = value;
        const response = await fetch(
          "http://doitand711gang.cse356.compas.cs.stonybrook.edu/api/like",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id, value: value }),
          }
        );
      }
      async function getVideos() {
        const response = await fetch(
          "http://doitand711gang.cse356.compas.cs.stonybrook.edu/api/videos",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ count }),
          }
        );

        if (response.ok) {
          const videoMetadatas = await response.json();
          console.log(videoMetadatas);
          videoMetadatas.videos.forEach((video) => {
            videos.push(video.id);
            loadVideo(video.id);
          });
        }

        // console.log(videos)
      }

      async function loadVideo(id) {
        var video = document.createElement("video");
        video.controls = true;
        video.width = 1280;

        var videoContainer = document.createElement("div");

        var player = dashjs.MediaPlayer().create();
        player.initialize(
          video,
          `http://doitand711gang.cse356.compas.cs.stonybrook.edu/api/manifest/${id}_output.mpd`,
          true
        );

        console.log("CALLING API/VIEW");
        /**
        @TODO Make API call to /api/view to mark video as viewed
        */
        await fetch(
          "http://doitand711gang.cse356.compas.cs.stonybrook.edu/api/view",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id: id }),
            // body: id,
          }
        );

        const playPauseBtn = document.createElement("div");
        playPauseBtn.id = "playPauseBtn";
        playPauseBtn.innerHTML = "Play/Pause";

        playPauseBtn.addEventListener("click", function () {
          if (video.paused) {
            video.play();
          } else {
            video.pause();
          }
        });

        // Like/Dislike button
        const likeBtn = document.createElement("button");
        likeBtn.id = "likeBtn";
        likeBtn.innerHTML = "Like";
        likeBtn.addEventListener("click", async function () {
          console.log("SENDING LIKES ....");
          await updateLike(id, true);
        });

        const dislikeBtn = document.createElement("button");
        dislikeBtn.id = "dislikeBtn";
        dislikeBtn.innerHTML = "Dislike";
        dislikeBtn.addEventListener("click", async function () {
          console.log("SENDING DISLIKES ....");

          await updateLike(id, false);
        });

        videoContainer.appendChild(video);
        videoContainer.appendChild(playPauseBtn);
        videoContainer.appendChild(likeBtn);
        videoContainer.appendChild(dislikeBtn);
        // videoContainer.appendChild(seekBtn);
        // videoContainer.appendChild(resolutionSelect);
        container.appendChild(videoContainer);
      }

      window.onload = function () {
        const id = window.location.pathname.split("/")[2];
        videos.push(id);

        loadVideo(id);
        getVideos();
      };

    //   window.addEventListener("scroll", () => {
    //     // Check if we are near the bottom of the page
    //     if (
    //       window.innerHeight + window.scrollY >=
    //       document.body.offsetHeight - 100
    //     ) {
    //       getVideos();
    //     } else {
    //       // Calculate the index of the video based on the scroll position
    //       const videoIndex = Math.floor(window.scrollY / 120) % videos.length;

    //       // Update the URL for the current video
    //       window.history.replaceState(
    //         null,
    //         null,
    //         `http://doitand711gang.cse356.compas.cs.stonybrook.edu/play/${videos[videoIndex]}`
    //       );

    //       // Find the next video section element
    //       const nextVideoSection = document.getElementById(
    //         `video${videoIndex + 1}`
    //       ); // Assumes video IDs are in the format 'video1', 'video2', etc.

    //       // Check if the next video section exists
    //       if (nextVideoSection) {
    //         // Scroll to the next video section smoothly
    //         nextVideoSection.scrollIntoView({ behavior: "smooth" });
    //       }
    //     }
    //   });
    </script>
  </body>
</html>
